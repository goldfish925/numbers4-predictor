
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>NUMBERS4äºˆæƒ³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      background-color: #ffffff;
      color: #c1a57b;
      text-align: center;
      padding: 20px;
    }
    h1 {
      font-size: 28px;
    }
    button {
      background-color: #c1a57b;
      color: #5a4635;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    #result, #details {
      margin-top: 20px;
    }
    #details {
      font-size: 14px;
      white-space: pre-line;
      color: #7c6240;
    }
    img {
      max-width: 150px;
      margin-top: 20px;
    }
    table {
      border-collapse: collapse;
      margin: 1em auto;
      width: auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.4em 0.8em;
      text-align: center;
    }
    th {
      background-color: #f0f8ff;
    }
    .input-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
  #details {
    font-family: 'Arial', sans-serif;
    max-width: 400px;
    margin: 20px auto;
  }
  #details h3 {
    text-align: center;
    color: #2a4d69;
    margin-bottom: 20px;
  }
  .prediction-card {
    background: #fff;
    border: 2px solid #2a4d69;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 6px rgba(42, 77, 105, 0.3);
  }
  .prediction-card strong {
    color: #1e2a47;
  }
  .prediction-icon {
    font-size: 1.2em;
    margin-right: 8px;
  }

  </style>
</head>
<body>
  <h1>NUMBERS4äºˆæƒ³</h1>
  <div class="center">
    <img src="neco.png" alt="ã«ã‚ƒã‚“ã“" />
  </div>
  <div class="input-row">
    <input type="file" id="csvFile" accept=".csv,.txt" />
    <button id="predictButton">äºˆæƒ³</button>
  </div>
  <div id="result">ã“ã“ã«äºˆæ¸¬ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆ</div>
  <div id="details"></div>
  <div id="table-container"></div>
  
    <script>
    document.getElementById('predictButton').addEventListener('click', predict);

    // é¢¨è»Šé †é…åˆ—å®šç¾©
    const wheels = {
      åƒ: [0, 3, 6, 9, 2, 5, 8, 1, 4, 7],
      ç™¾: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
      å: [0, 7, 4, 1, 8, 5, 2, 9, 6, 3],
      ä¸€: [0, 9, 8, 7, 6, 5, 4, 3, 2, 1],
    };
    const positions = ['åƒ', 'ç™¾', 'å', 'ä¸€'];

    // ãƒŸãƒ©ãƒ¼æ•°å­—å¯¾å¿œè¡¨
    const mirrorMap = { 0:5, 1:6, 2:7, 3:8, 4:9, 5:0, 6:1, 7:2, 8:3, 9:4 };

    // CSVãƒ‘ãƒ¼ã‚¹: æ—¥ä»˜,ç•ªå·åˆ—ã‚’æŠ½å‡ºã—ã€æ—¥ä»˜é™é †ã§ä¸¦ã¹ã‚‹
    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const data = lines.slice(1).map(line => {
        const columns = line.split(',');
        if (columns.length < 3) return null;
        const date = columns[1].trim();
        let number = columns[2].trim();
        number = number.replace(/^="?/, '').replace(/"?$/, '').replace(/[^\d]/g, '');
        if(number.length !== 4) return null;
        return { date, number };
      }).filter(entry => entry);
      data.sort((a,b) => new Date(b.date) - new Date(a.date));
      return data;
    }

    // å·®åˆ†ãƒ‘ã‚¿ãƒ¼ãƒ³æŠ½å‡º
    function getWheelDifferences(prevNumber, currentNumber) {
      const prevDigits = prevNumber.padStart(4,'0').split('').map(Number);
      const currDigits = currentNumber.padStart(4,'0').split('').map(Number);
      const diffs = positions.map((pos,i) => {
        const wheel = wheels[pos];
        const prevIdx = wheel.indexOf(prevDigits[i]);
        const currIdx = wheel.indexOf(currDigits[i]);
        const leftSteps = (prevIdx - currIdx + 10) % 10;
        const rightSteps = (currIdx - prevIdx + 10) % 10;
        const direction = leftSteps <= rightSteps ? 'å·¦' : 'å³';
        const steps = Math.min(leftSteps, rightSteps);
        return `${direction}${steps}`;
      });
      return { prev: prevNumber, curr: currentNumber, diffs };
    }

    // å·®åˆ†ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é »åº¦é›†è¨ˆ
    function collectDiffPatternFrequency(data) {
      const freqMap = {};
      for(let i=1; i<data.length; i++) {
        const diffObj = getWheelDifferences(data[i-1].number, data[i].number);
        const key = diffObj.diffs.join(',');
        freqMap[key] = (freqMap[key] || 0) + 1;
      }
      return freqMap;
    }

    // ä¸Šä½Nä»¶æŠ½å‡º
    function getTopDiffPatterns(freqMap, topN=3) {
      return Object.entries(freqMap)
        .sort((a,b) => b[1] - a[1])
        .slice(0, topN)
        .map(([pattern, count]) => ({ pattern: pattern.split(','), count }));
    }

    // äºˆæ¸¬æ•°å­—ç®—å‡ºï¼šç¾åœ¨ã®æ•°å­—ï¼‹å·®åˆ†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¢¨è»Šé †ã§æ¬¡ã®æ•°å­—ã«å¤‰æ›
    function predictNextNumber(currentNumber, pattern) {
      const currDigits = currentNumber.padStart(4,'0').split('').map(Number);
      const nextDigits = [];
      pattern.forEach((diff,i) => {
        const wheel = wheels[positions[i]];
        const currDigit = currDigits[i];
        const currIdx = wheel.indexOf(currDigit);
        const direction = diff[0];
        const steps = parseInt(diff.slice(1));
        const nextIdx = direction === 'å·¦'
          ? (currIdx - steps + 10) % 10
          : (currIdx + steps) % 10;
        nextDigits.push(wheel[nextIdx]);
      });
      return nextDigits.join('');
    }

    // è£œæ­£ï¼ˆèª¤å·®ï¼‰é©ç”¨
    function applyErrorCorrection(predictedNum, errorStr) {
      const digits = predictedNum.padStart(4,'0').split('').map(Number);
      const errorNums = errorStr.split(' ').map(s => {
        if(s.startsWith('+')) return Number(s.slice(1));
        if(s.startsWith('Â±')) return 0;
        return Number(s);
      });
      const correctedDigits = digits.map((d,i) => {
        const wheel = wheels[positions[i]];
        const idx = wheel.indexOf(d);
        const correctedIdx = (idx - errorNums[i] + 10) % 10;
        return wheel[correctedIdx];
      });
      return correctedDigits.join('');
    }

    // ãƒŸãƒ©ãƒ¼æ•°å­—å¤‰æ›
    function mirror(num) {
      return num.split('').map(d => mirrorMap[d] ?? d).join('');
    }

    // äºˆæ¸¬å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³
    function predict() {
      const fileInput = document.getElementById('csvFile');
      if(!fileInput.files.length) {
        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­ï¼');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        const csvText = e.target.result;
        const allData = parseCSV(csvText);
        if(allData.length < 2) {
          alert('ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã§ã™ã€‚ã‚‚ã£ã¨éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¦ã­ã€‚');
          return;
        }

        // ç›´è¿‘11ä»¶ã§è§£æï¼ˆé©å®œèª¿æ•´å¯ï¼‰
        const data = allData.slice(-11).reverse(); 

        // å·®åˆ†ãƒ‘ã‚¿ãƒ¼ãƒ³é »åº¦è§£æ
        const freqMap = collectDiffPatternFrequency(data);
        let topPatterns = getTopDiffPatterns(freqMap, 5);

        const latestNumber = allData[0].number;
        const previousNumber = allData[1]?.number ?? '';

        // ç›´è¿‘ã¨ã®äºˆæ¸¬é‡è¤‡æ’é™¤ï¼†ä¸Šä½3ä»¶ã«çµã‚‹
        topPatterns = topPatterns.filter(item => predictNextNumber(latestNumber, item.pattern) !== previousNumber).slice(0,3);

        const resultArea = document.getElementById('details');
        resultArea.innerHTML = '<h3>äºˆæ¸¬çµæœ</h3>';

        const actualNumber = data[0].number;
        const errorDigits = actualNumber.padStart(4,'0').split('').map(Number);

        topPatterns.forEach(item => {
          const predictedNum = predictNextNumber(latestNumber, item.pattern);
          const predictedDigits = predictedNum.padStart(4,'0').split('').map(Number);

          // èª¤å·®è¨ˆç®—ï¼ˆäºˆæ¸¬æ•°å­— - å®Ÿéš›ã®å½“é¸æ•°å­—ï¼‰
          const error = predictedDigits.map((digit,idx) => {
            const diff = digit - errorDigits[idx];
            const sign = diff > 0 ? '+' : (diff === 0 ? 'Â±0' : '');
            return `${sign}${diff}`;
          }).join(' ');

          const correctedNum = applyErrorCorrection(predictedNum, error);

          // é€†é †ç•ªå·ãƒã‚§ãƒƒã‚¯
          const reversed = correctedNum.split('').reverse().join('');
          const hitReversed = allData.some(entry => entry.number === reversed);

          // ãƒŸãƒ©ãƒ¼æ•°å­—
          const mirrorOriginal = mirror(predictedNum.padStart(4,'0'));
          const mirrorCorrected = mirror(correctedNum.padStart(4,'0'));
          const hitMirrorOriginal = allData.some(entry => entry.number === mirrorOriginal);
          const hitMirrorCorrected = allData.some(entry => entry.number === mirrorCorrected);

          resultArea.innerHTML += `
            <div class="prediction-card">
              <div>ğŸ”® <strong>äºˆæ¸¬ç•ªå·:</strong> ${predictedNum}</div>
              <div>ğŸ”§ <strong>è£œæ­£å¾Œäºˆæ¸¬ç•ªå·:</strong> ${correctedNum}</div>
              <div>ğŸ‡ <strong>ãƒŸãƒ©ãƒ¼ç•ªå·:</strong> ${mirrorOriginal} ${hitMirrorOriginal ? 'âœ… å‡ºç¾ã‚ã‚Šï¼' : 'âŒ æœªå‡ºç¾'}</div>
              <div>ğŸª <strong>è£œæ­£å¾ŒãƒŸãƒ©ãƒ¼:</strong> ${mirrorCorrected} ${hitMirrorCorrected ? 'âœ… å‡ºç¾ã‚ã‚Šï¼' : 'âŒ æœªå‡ºç¾'}</div>
              <div>ğŸ” <strong>é€†é †ç•ªå·:</strong> ${reversed} ${hitReversed ? 'âœ… å‡ºç¾ã‚ã‚Šï¼' : 'âŒ æœªå‡ºç¾'}</div>
              <div>ğŸ¯ <strong>å·®åˆ†ãƒ‘ã‚¿ãƒ¼ãƒ³:</strong> ${item.pattern.join(', ')}</div>
              <div>ğŸŒ€ <strong>å‡ºç¾å›æ•°:</strong> ${item.count}</div>
              <div>ğŸ“ <strong>èª¤å·®:</strong> ${error}</div>
            </div>
          `;
        });

        // å·®åˆ†ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
        const container = document.getElementById('table-container');
        container.innerHTML = '';
        const table = document.createElement('table');
        const header = document.createElement('tr');
        header.innerHTML = `<th>æ—¥ä»˜</th><th>å½“é¸ç•ªå·</th><th>åƒ</th><th>ç™¾</th><th>å</th><th>ä¸€</th>`;
        table.appendChild(header);

        // æœ€æ–°è¡Œï¼ˆæ—¥ä»˜ãƒ»ç•ªå·ã®ã¿ï¼‰
        const firstRow = document.createElement('tr');
        firstRow.innerHTML = `<td>${data[0].date}</td><td>${data[0].number}</td><td></td><td></td><td></td><td></td>`;
        table.appendChild(firstRow);

        // å·®åˆ†è¡Œ
        for(let i=1; i<data.length; i++) {
          const diffData = getWheelDifferences(data[i-1].number, data[i].number);
          const row = document.createElement('tr');
          const diffCells = diffData.diffs.map(d => {
            const color = d.startsWith('å³') ? 'red' : 'green';
            return `<td style="color:${color}">${d}</td>`;
          });
          row.innerHTML = `<td>${data[i].date}</td><td>${diffData.curr}</td>` + diffCells.join('');
          table.appendChild(row);
        }

        container.appendChild(table);

      };
      reader.readAsText(fileInput.files[0]);
    }
  </script> 
</body>
</html>
