
<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8" />
 <title>NUMBERS4予想</title>
 <style>
  body {
   font-family: "Hiragino Kaku Gothic ProN", sans-serif;
   background-color: #ffffff;
   color: #5a4635;
   text-align: center;
   padding: 20px;

  }

  h1 {
   font-size: 28px;
   color: #c1a57b; /* ココア色 */
   margin-top: 40px;

  }
  h3 {
   color: #c1a57b;
  }

  button {
   background-color: #c1a57b;
   color: #ffffff;
   padding: 10px 20px;
   border: none;
   border-radius: 8px;
   font-size: 16px;
   cursor: pointer;
   margin-top: 10px;

  }

  .prediction-box {
   background-color: #ffffff; /* ← 白背景に修正 */
   border: 2px solid #c1a57b;
   border-radius: 12px;
   padding: 15px;
   margin: 20px auto;
   max-width: 320px;
   box-shadow: 0 4px 8px rgba(193, 165, 123, 0.2);

  }



  #predictionList {
   font-size: 1.6em;
   list-style: none;
   padding: 0;
   margin: 0;

  }



  table {
   border-collapse: collapse;
   margin: 0 auto;
   margin-top: 20px;

  }

  th, td {

   border: 1px solid #d8c4a0; /* ミルクティー系の淡い線 */
   padding: 6px 10px;

  }



  th {

   background-color: #fdf7f0;
   color: #5a4635;

  }



  td {

   background-color: #fff;

  }



  .neco-image {
   width: 120px;
   margin-bottom: 10px;

  }

 </style>

</head>

<body>
 <img src="neco.png" alt="ねこ" class="neco-image" />

  

 <div class="prediction-box">

  <h3>🔮予測数字🔮</h3>

  <ul id="predictionList"></ul>

 </div>



 <h1>NUMBERS4予想</h1>

 <input type="file" id="csvFile" accept=".csv" />

 <button id="predictButton">予測開始</button>

 <div id="details"></div>
 </style>
</head>
<body>

  <img src="neco.png" alt="ねこ" class="neco-image">
  <h1>NUMBERS4予想</h1>

    <!-- 📂 入力エリア -->
  <input type="file" id="csvFile" accept=".csv" />
  <button id="predictButton">予測開始</button>

  
  <!-- 🔄 差分＆一致テーブル（←一番下に配置！） -->
  <div id="details" style="margin-top: 60px;">
    <div class="tables-wrapper">
      <div id="diffTable"></div>
      <div id="matchTable"></div>
    </div>
  </div>

</body>



 <script>
  const wheels = {
   千: [0,3,6,9,2,5,8,1,4,7],
   百: [0,1,2,3,4,5,6,7,8,9],
   十: [0,7,4,1,8,5,2,9,6,3],
   一: [0,9,8,7,6,5,4,3,2,1],

  };
  const positions = ['千','百','十','一'];

  document.getElementById('predictButton').addEventListener('click', predict);


  function parseCSV(text) {
   return text.trim().split('\n').slice(1).map(line => {
    const cols = line.split(',');
    const date = cols[1]?.trim();
    const number = cols[2]?.trim().replace(/[^\d]/g, '').padStart(4,'0');
    return { date, number };
   });

  }

  function getWheelDiffs(prev, curr) {
   if (!prev || !curr || prev.length < 4 || curr.length < 4) return ['','','',''];
   const p = prev.split('').map(Number);
   const c = curr.split('').map(Number);
   return positions.map((pos, i) => {
    const wheel = wheels[pos];
    const pi = wheel.indexOf(p[i]);
    const ci = wheel.indexOf(c[i]);
    const left = (pi - ci + 10) % 10;
    const right = (ci - pi + 10) % 10;
    return (left <= right ? '左' : '右') + Math.min(left, right);
   });

  }

  function countBoxMatch(pred, actual) {
   const p = pred.split('').sort().join('');
   const a = actual.split('').sort().join('');
   let count = 0;
   for (let i = 0; i < 4; i++) {
    if (p[i] === a[i]) count++;
   }
   return count;

  }

  function predict() {
  const file = document.getElementById('csvFile').files[0];
  if (!file) return alert('CSVファイルを選択してください');

  const reader = new FileReader();
  reader.onload = e => {
    let data = parseCSV(e.target.result);

    // 明日の日付を追加
    const lastDate = new Date(data[data.length - 1].date);
    lastDate.setDate(lastDate.getDate() + 1);
    while (lastDate.getDay() === 0 || lastDate.getDay() === 6) {
      lastDate.setDate(lastDate.getDate() + 1);
    }
    const yyyy = lastDate.getFullYear();
const mm = lastDate.getMonth() + 1;  // ← そのまま数値でOK
const dd = lastDate.getDate();
const nextDateStr = `${lastDate.getFullYear()}/${mm}/${dd}`;

    data.push({ date: nextDateStr, number: '' });

    const reversedData = [...data].reverse();

    // 一致数カウント関数（ボックス）
    function countBoxMatch(pred, actual) {
      const p = pred.split('');
      const a = actual.split('');
      let count = 0;
      const used = Array(4).fill(false);
      for (let i = 0; i < p.length; i++) {
        for (let j = 0; j < a.length; j++) {
          if (!used[j] && p[i] === a[j]) {
            count++;
            used[j] = true;
            break;
          }
        }
      }
      return count;
    }

    // ===== 差分テーブル作成 =====
    const diffTable = document.createElement('table');
   diffTable.className = 'diff-table'; 
    diffTable.innerHTML = '<tr><th>日付</th><th>番号</th><th>千</th><th>百</th><th>十</th><th>一</th></tr>';

    for (let i = 0; i < reversedData.length - 1; i++) {
      const curr = reversedData[i];
      const prev = reversedData[i + 1];
      const diffs = (curr.number && prev?.number) ? getWheelDiffs(prev.number, curr.number) : ['', '', '', ''];
      const tr = document.createElement('tr');
      const diffTds = diffs.map(d => {
        const color = d.startsWith('右') ? 'red' : d.startsWith('左') ? 'green' : 'black';
        return `<td style="color:${color}">${d}</td>`;
      });
      tr.innerHTML = `<td>${curr.date}</td><td>${curr.number}</td>${diffTds.join('')}`;
      diffTable.appendChild(tr);
    }
   
function getIndexDiffStats(data) {
  const diffStats = { 千: {}, 百: {}, 十: {}, 一: {} };
  for (let i = 1; i < data.length; i++) {
    const prev = data[i - 1].number;
    const curr = data[i].number;
    if (!prev || !curr) continue;
    positions.forEach((pos, j) => {
      const wheel = wheels[pos];
      const pi = wheel.indexOf(Number(prev[j]));
      const ci = wheel.indexOf(Number(curr[j]));
      if (pi === -1 || ci === -1) return;
      const right = (ci - pi + 10) % 10;
      const left = (pi - ci + 10) % 10;
      const diff = (left <= right) ? -left : right;
      diffStats[pos][diff] = (diffStats[pos][diff] || 0) + 1;
    });
  }
  return diffStats;
}

   function generateTopPredictions(latestNumber, diffStats, count = 3) {
  const candidates = [];

  for (let k = 0; k < count; k++) {
    const predictedDigits = positions.map((pos, i) => {
      const wheel = wheels[pos];
      const digit = Number(latestNumber[i]);
      const currentIndex = wheel.indexOf(digit);
      if (currentIndex === -1) return digit;

      const diffs = diffStats[pos];
      const sorted = Object.entries(diffs)
        .sort((a, b) => b[1] - a[1])
        .map(([d]) => parseInt(d));

      const diff = sorted[k] ?? 0;
      const newIndex = (currentIndex + diff + 10) % 10;
      return wheel[newIndex];
    });

    candidates.push(predictedDigits.join(''));
  }

  return [...new Set(candidates)];
}

  
    // ===== 予測数字（3件） =====
    const diffStats = getIndexDiffStats(data.slice(1));
    const latestNumber = data[data.length - 2].number;
    const predictions = generateTopPredictions(latestNumber, diffStats, 3);

    const predictionList = document.getElementById('predictionList');
    predictionList.innerHTML = '';
    predictions.forEach(num => {
      const li = document.createElement('li');
      li.textContent = `🦉 ${num}`;
      predictionList.appendChild(li);
    });
   
    // 表示エリアクリア＆再構築
const container = document.getElementById('details');
container.innerHTML = '';

const wrapper = document.createElement('div');
wrapper.style.display = 'flex';
wrapper.style.justifyContent = 'center';

const diffDiv = document.createElement('div');
diffDiv.appendChild(diffTable);
wrapper.appendChild(diffDiv);

container.appendChild(wrapper);
};

  reader.readAsText(file);
}

 </script>

</body>

</html>


