
<!DOCTYPE html>
<html lang="ja">
 
<head>

 <meta charset="UTF-8">
 <title>NUMBERS4予想</title>

 <style>
  body {
   font-family: "Hiragino Kaku Gothic ProN", sans-serif;
   background-color: #ffffff;
   color: #5a4635;
   text-align: center;
   padding: 20px;
  }
  h1 {
   font-size: 28px;
   color: #c1a57b;
   margin-bottom: 10px;
  }
  button {
   background-color: #c1a57b;
   color: #ffffff;
   padding: 10px 20px;
   border: none;
   border-radius: 8px;
   font-size: 16px;
   cursor: pointer;
  }
  .prediction-box {
   background: #ffffff;
   border: 2px solid #c1a57b;
   border-radius: 12px;
   padding: 15px;
   margin: 20px auto;
   max-width: 400px;
   box-shadow: 0 4px 8px rgba(193, 165, 123, 0.2);
  }
  .prediction-box h3 {
   margin-top: 0;
   font-size: 20px;
  }
  #predictionList {
   font-size: 1.6em;
   list-style: none;
   padding: 0;
   margin: 0;
  }
  .tables-wrapper {
   display: flex;
   justify-content: center;
   gap: 40px;
   margin-top: 30px;
   flex-wrap: wrap;
  }
  .tables-wrapper table {
   border-collapse: collapse;
   min-width: 320px;
   font-size: 14px;
   background-color: #fff;
   color: #5a4635;
  }
  .tables-wrapper th,
  .tables-wrapper td {
   border: 1px solid #d8c8aa;
   padding: 6px 10px;
   text-align: center;
  }
  
 </style>
</head>
<body>

 <img src="neco.png" alt="ねこ" class="neco-image">
 <h1>NUMBERS4予想</h1>
 
 <div class="prediction-box">
  <h3>🔮予測数字🔮</h3>
  <ul id="predictionList"></ul>
 </div> <!-- ←ここでちゃんと閉じる！ -->

 <!-- 🔄 差分と一致テーブル -->
 <div id="details">
   <div class="tables-wrapper">
     <div id="diffTable"></div>
     <div id="matchTable"></div>
   </div>
 </div>

 <!-- 🧾 入力とボタン -->
 <input type="file" id="csvFile" accept=".csv" />
 <button id="predictButton">予測開始</button>

 <!-- 🕊️ 履歴 -->
 <h3>ボックス一致記録（履歴）</h3>
 <table id="boxMatchTable" border="1" style="margin: 20px auto; border-collapse: collapse;">
   <tr>
     <th>日付</th>
     <th>当選番号</th>
     <th>予測①</th><th>一致</th>
     <th>予測②</th><th>一致</th>
     <th>予測③</th><th>一致</th>
   </tr>
 </table>
</body>


 <script>
  const wheels = {
   千: [0,3,6,9,2,5,8,1,4,7],
   百: [0,1,2,3,4,5,6,7,8,9],
   十: [0,7,4,1,8,5,2,9,6,3],
   一: [0,9,8,7,6,5,4,3,2,1],

  };
  const positions = ['千','百','十','一'];

  document.getElementById('predictButton').addEventListener('click', predict);


  function parseCSV(text) {
   return text.trim().split('\n').slice(1).map(line => {
    const cols = line.split(',');
    const date = cols[1]?.trim();
    const number = cols[2]?.trim().replace(/[^\d]/g, '').padStart(4,'0');
    return { date, number };
   });

  }

  function getWheelDiffs(prev, curr) {
   if (!prev || !curr || prev.length < 4 || curr.length < 4) return ['','','',''];
   const p = prev.split('').map(Number);
   const c = curr.split('').map(Number);
   return positions.map((pos, i) => {
    const wheel = wheels[pos];
    const pi = wheel.indexOf(p[i]);
    const ci = wheel.indexOf(c[i]);
    const left = (pi - ci + 10) % 10;
    const right = (ci - pi + 10) % 10;
    return (left <= right ? '左' : '右') + Math.min(left, right);
   });

  }

  function countBoxMatch(pred, actual) {
   const p = pred.split('').sort().join('');
   const a = actual.split('').sort().join('');
   let count = 0;
   for (let i = 0; i < 4; i++) {
    if (p[i] === a[i]) count++;
   }
   return count;

  }

  function predict() {
  const file = document.getElementById('csvFile').files[0];
  if (!file) return alert('CSVファイルを選択してください');

  const reader = new FileReader();
  reader.onload = e => {
    let data = parseCSV(e.target.result);

    // 明日の日付を追加
    const lastDate = new Date(data[data.length - 1].date);
    lastDate.setDate(lastDate.getDate() + 1);
    while (lastDate.getDay() === 0 || lastDate.getDay() === 6) {
      lastDate.setDate(lastDate.getDate() + 1);
    }
    const yyyy = lastDate.getFullYear();
    const mm = String(lastDate.getMonth() + 1).padStart(2, '0');
    const dd = String(lastDate.getDate()).padStart(2, '0');
    const nextDateStr = `${yyyy}/${mm}/${dd}`;
    data.push({ date: nextDateStr, number: '' });

    const reversedData = [...data].reverse();

    // 一致数カウント関数（ボックス）
    function countBoxMatch(pred, actual) {
      const p = pred.split('');
      const a = actual.split('');
      let count = 0;
      const used = Array(4).fill(false);
      for (let i = 0; i < p.length; i++) {
        for (let j = 0; j < a.length; j++) {
          if (!used[j] && p[i] === a[j]) {
            count++;
            used[j] = true;
            break;
          }
        }
      }
      return count;
    }

    // ===== 差分テーブル作成 =====
    const diffTable = document.createElement('table');
    diffTable.innerHTML = '<tr><th>日付</th><th>番号</th><th>千</th><th>百</th><th>十</th><th>一</th></tr>';

    for (let i = 0; i < reversedData.length - 1; i++) {
      const curr = reversedData[i];
      const prev = reversedData[i + 1];
      const diffs = (curr.number && prev?.number) ? getWheelDiffs(prev.number, curr.number) : ['', '', '', ''];
      const tr = document.createElement('tr');
      const diffTds = diffs.map(d => {
        const color = d.startsWith('右') ? 'red' : d.startsWith('左') ? 'green' : 'black';
        return `<td style="color:${color}">${d}</td>`;
      });
      tr.innerHTML = `<td>${curr.date}</td><td>${curr.number}</td>${diffTds.join('')}`;
      diffTable.appendChild(tr);
    }
   
function getIndexDiffStats(data) {
  const diffStats = { 千: {}, 百: {}, 十: {}, 一: {} };
  for (let i = 1; i < data.length; i++) {
    const prev = data[i - 1].number;
    const curr = data[i].number;
    if (!prev || !curr) continue;
    positions.forEach((pos, j) => {
      const wheel = wheels[pos];
      const pi = wheel.indexOf(Number(prev[j]));
      const ci = wheel.indexOf(Number(curr[j]));
      if (pi === -1 || ci === -1) return;
      const right = (ci - pi + 10) % 10;
      const left = (pi - ci + 10) % 10;
      const diff = (left <= right) ? -left : right;
      diffStats[pos][diff] = (diffStats[pos][diff] || 0) + 1;
    });
  }
  return diffStats;
}

   function generateTopPredictions(latestNumber, diffStats, count = 3) {
  const candidates = [];

  for (let k = 0; k < count; k++) {
    const predictedDigits = positions.map((pos, i) => {
      const wheel = wheels[pos];
      const digit = Number(latestNumber[i]);
      const currentIndex = wheel.indexOf(digit);
      if (currentIndex === -1) return digit;

      const diffs = diffStats[pos];
      const sorted = Object.entries(diffs)
        .sort((a, b) => b[1] - a[1])
        .map(([d]) => parseInt(d));

      const diff = sorted[k] ?? 0;
      const newIndex = (currentIndex + diff + 10) % 10;
      return wheel[newIndex];
    });

    candidates.push(predictedDigits.join(''));
  }

  return [...new Set(candidates)];
}

  
    // ===== 予測数字（3件） =====
    const diffStats = getIndexDiffStats(data.slice(1));
    const latestNumber = data[data.length - 2].number;
    const predictions = generateTopPredictions(latestNumber, diffStats, 3);

    const predictionList = document.getElementById('predictionList');
    predictionList.innerHTML = '';
    predictions.forEach(num => {
      const li = document.createElement('li');
      li.textContent = `🦉 ${num}`;
      predictionList.appendChild(li);
    });

    // ===== 一致テーブル作成 =====
    const matchTable = document.createElement('table');
    matchTable.innerHTML = '<tr><th>日付</th><th>当選番号</th><th>予測①</th><th>一致</th><th>予測②</th><th>一致</th><th>予測③</th><th>一致</th></tr>';
    for (let i = 1; i < reversedData.length; i++) {
      const current = reversedData[i];
      if (!current.number) continue;
      const row = document.createElement('tr');
      const counts = predictions.map(p => countBoxMatch(p, current.number));
      row.innerHTML = `
        <td>${current.date}</td>
        <td>${current.number}</td>
        <td>${predictions[0]}</td><td>${counts[0]}個</td>
        <td>${predictions[1]}</td><td>${counts[1]}個</td>
        <td>${predictions[2]}</td><td>${counts[2]}個</td>`;
      matchTable.appendChild(row);
    }

    // ===== 横並びに表示 =====
    const container = document.getElementById('details');
    container.innerHTML = '';

    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.justifyContent = 'center';
    wrapper.style.gap = '40px'; // 間隔

    const diffDiv = document.createElement('div');
    const matchDiv = document.createElement('div');

    diffDiv.appendChild(diffTable);
    matchDiv.appendChild(matchTable);

    wrapper.appendChild(diffDiv);
    wrapper.appendChild(matchDiv);
    container.appendChild(wrapper);
  };

  reader.readAsText(file);
}

 </script>

</body>

</html>


