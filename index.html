
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Numbers4äºˆæ¸¬ãƒ„ãƒ¼ãƒ«ğŸ¾</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      padding: 20px;
      background: #fffafc;
      color: #333;
    }
    h1 {
      font-size: 24px;
      color: #8b5e83;
    }
    table {
      border-collapse: collapse;
      margin-bottom: 20px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      background-color: #f7e8f0;
    }
  </style>
</head>
<body>
  <h1>Numbers4äºˆæ¸¬ãƒ„ãƒ¼ãƒ«ğŸ¾</h1>

  <input type="file" id="csvFile" accept=".csv" />
  <br /><br />
  <label><input type="radio" name="mode" value="recent" checked /> æœ€æ–°20ä»¶</label>
  <label><input type="radio" name="mode" value="all" /> å…¨ä½“</label>
  <br /><br />
  <button onclick="predict()">äºˆæ¸¬ã™ã‚‹ï¼</button>

  <p id="result"></p>
  <div id="details"></div>

  <script>
    function getSlideDiffTable(nums, label) {
      if (nums.length < 2) return `<p>${label}ï¼šãƒ‡ãƒ¼ã‚¿ä¸è¶³</p>`;
      let table = `<h3>ğŸ” ${label}ã®ã‚¹ãƒ©ã‚¤ãƒ‰å·®ï¼ˆè¡¨ï¼‰</h3>`;
      table += `
        <table>
          <tr>
            <th>No.</th><th>å‰å›</th><th>ä»Šå›</th>
            <th>åƒ</th><th>ç™¾</th><th>å</th><th>ä¸€</th>
          </tr>
      `;

      for (let i = 1; i < nums.length; i++) {
        const prev = nums[i - 1];
        const curr = nums[i];
        const diffs = [];

        for (let j = 0; j < 4; j++) {
          const d = (parseInt(curr[j]) - parseInt(prev[j]) + 10) % 10;
          const slide = (d <= 5) ? d : d - 10;
          diffs.push((slide >= 0 ? "+" : "") + slide);
        }

        table += `
          <tr>
            <td>${i}</td><td>${prev}</td><td>${curr}</td>
            <td>${diffs[0]}</td><td>${diffs[1]}</td><td>${diffs[2]}</td><td>${diffs[3]}</td>
          </tr>
        `;
      }

      table += `</table>`;
      return table;
    }

    function predict() {
      const fileInput = document.getElementById("csvFile");
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const result = document.getElementById("result");
      const details = document.getElementById("details");

      const file = fileInput.files[0];
      if (!file) {
        alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­ï¼");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const lines = text.trim().split("\n").slice(1); // ãƒ˜ãƒƒãƒ€ãƒ¼é™¤å¤–

        let numbers = lines
          .map(line => {
            const cols = line.split(",");
            const raw = cols[2] || "";
            const match = raw.match(/\d{4}/);
            return match ? match[0] : null;
          })
          .filter(Boolean);

        const allNumbers = [...numbers];
        if (mode === "recent") {
          numbers = numbers.slice(-20);
        }

        let detailText = "<h3>ğŸ¯ ã‚ˆãå‡ºãŸæ•°å­—ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼š</h3><ul>";
        const count = {};
        numbers.forEach(num => {
          for (const digit of num) {
            count[digit] = (count[digit] || 0) + 1;
          }
        });
        const sorted = Object.entries(count).sort((a, b) => b[1] - a[1]);
        sorted.forEach(([digit, freq]) => {
          detailText += `<li>ã€Œ${digit}ã€ãŒ ${freq} å›</li>`;
        });
        detailText += "</ul>";

        // å„æ¡ã”ã¨ã®å‡ºç¾å‚¾å‘
        let positionStats = [ {}, {}, {}, {} ];
        numbers.forEach(num => {
          for (let i = 0; i < 4; i++) {
            const digit = num[i];
            positionStats[i][digit] = (positionStats[i][digit] || 0) + 1;
          }
        });

        const posName = ["åƒ", "ç™¾", "å", "ä¸€"];
        detailText += "<h3>ğŸ”¢ å„æ¡ã”ã¨ã®å‡ºã‚„ã™ã„æ•°å­—ï¼š</h3>";
        for (let i = 0; i < 4; i++) {
          detailText += `<strong>ã€${posName[i]}ã®ä½ã€‘</strong><ul>`;
          const sortedPos = Object.entries(positionStats[i]).sort((a, b) => b[1] - a[1]);
          sortedPos.forEach(([digit, count]) => {
            detailText += `<li>${digit}ï¼š${count} å›</li>`;
          });
          detailText += "</ul>";
        }

        // ã‚¹ãƒ©ã‚¤ãƒ‰å·®åˆ†ï¼ˆè¡¨è¡¨ç¤ºï¼‰
        detailText += getSlideDiffTable(numbers, "æœ€æ–°20ä»¶");
        detailText += getSlideDiffTable(allNumbers, "å…¨ä½“");

        // ã‚¹ãƒ©ã‚¤ãƒ‰å‚¾å‘ã‹ã‚‰ã®äºˆæ¸¬ï¼ˆ3ä»¶åˆ†ï¼‰
        if (numbers.length >= 4) {
          const diffs = [];

          for (let i = numbers.length - 3; i < numbers.length; i++) {
            const prev = numbers[i - 1];
            const curr = numbers[i];
            const diff = [];

            for (let j = 0; j < 4; j++) {
              const d = (parseInt(curr[j]) - parseInt(prev[j]) + 10) % 10;
              const slide = (d <= 5) ? d : d - 10;
              diff.push(slide);
            }

            diffs.push(diff);
          }

          const avgSlide = [0, 0, 0, 0];
          for (let i = 0; i < 4; i++) {
            let total = 0;
            for (let j = 0; j < diffs.length; j++) {
              total += diffs[j][i];
            }
            avgSlide[i] = Math.round(total / diffs.length);
          }

          const latest = numbers[numbers.length - 1];
          let prediction = "";
          for (let i = 0; i < 4; i++) {
            const newDigit = (parseInt(latest[i]) + avgSlide[i] + 10) % 10;
            prediction += newDigit;
          }

          detailText += `<h3>ğŸ”® ã‚¹ãƒ©ã‚¤ãƒ‰å‚¾å‘ã‹ã‚‰ã®äºˆæƒ³ï¼š</h3>`;
          detailText += `<p>å¹³å‡ã‚¹ãƒ©ã‚¤ãƒ‰ï¼š${avgSlide.map(v => (v >= 0 ? "+" : "") + v).join(" ")}</p>`;
          detailText += `<p>æœ€æ–°ï¼š${latest} â†’ <strong>${prediction}</strong></p>`;
        }

        result.innerHTML = "äºˆæƒ³å®Œäº†âœ¨";
        details.innerHTML = detailText;
      };

      reader.readAsText(file);
    }
  </script>
</body>
</html>
